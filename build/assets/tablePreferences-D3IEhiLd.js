import{s as i}from"./supabaseClient-VxXemYU-.js";import"./vendor-supabase-UKL6O6TB.js";import"./vendor-react-BQC692LR.js";import"./vendor-ui-CO0mBmim.js";class n{static instance;constructor(){}static getInstance(){return n.instance||(n.instance=new n),n.instance}async fetchPreferences(e,t,a="user"){try{const{data:r,error:s}=await i.from("table_preferences").select("*").eq("table_id",e).eq("user_id",t).eq("scope",a).single();if(s){if(s.code==="PGRST116")return null;throw s}return r?{tableId:r.table_id,userId:r.user_id,scope:r.scope,visibleColumns:r.visible_columns,columnOrder:r.column_order,columnWidths:r.column_widths,pinnedColumns:r.pinned_columns,currentView:r.current_view,lastModified:r.updated_at}:null}catch(r){return console.error("[TablePreferences] Failed to fetch preferences:",r),null}}async savePreferences(e){if(!e.userId)throw new Error("User ID is required to save preferences");try{const{error:t}=await i.from("table_preferences").upsert({table_id:e.tableId,user_id:e.userId,scope:e.scope||"user",visible_columns:e.visibleColumns,column_order:e.columnOrder,column_widths:e.columnWidths,pinned_columns:e.pinnedColumns,current_view:e.currentView,updated_at:new Date().toISOString()},{onConflict:"table_id,user_id,scope"});if(t)throw t}catch(t){throw console.error("[TablePreferences] Failed to save preferences:",t),t}}async fetchViews(e,t){try{const{data:a,error:r}=await i.from("table_views").select("*").eq("table_id",e).or(`created_by.eq.${t},is_shared.eq.true`).order("created_at",{ascending:!1});if(r)throw r;return(a||[]).map(s=>({id:s.id,name:s.name,description:s.description,tableId:s.table_id,columns:s.columns,columnWidths:s.column_widths,pinnedColumns:s.pinned_columns,createdBy:s.created_by,isShared:s.is_shared,sharedWith:s.shared_with,isDefault:s.is_default,createdAt:s.created_at,updatedAt:s.updated_at}))}catch(a){return console.error("[TablePreferences] Failed to fetch views:",a),[]}}async saveView(e,t){try{const a={id:t.id,table_id:e,name:t.name,description:t.description,columns:t.columns,column_widths:t.columnWidths,pinned_columns:t.pinnedColumns,created_by:t.createdBy,is_shared:t.isShared||!1,shared_with:t.sharedWith||[],is_default:t.isDefault||!1,updated_at:new Date().toISOString()};if(t.id){const{data:r,error:s}=await i.from("table_views").update(a).eq("id",t.id).select().single();if(s)throw s;return this.mapViewFromDb(r)}else{const{data:r,error:s}=await i.from("table_views").insert({...a,created_at:new Date().toISOString()}).select().single();if(s)throw s;return this.mapViewFromDb(r)}}catch(a){throw console.error("[TablePreferences] Failed to save view:",a),a}}async deleteView(e){try{const{error:t}=await i.from("table_views").delete().eq("id",e);if(t)throw t}catch(t){throw console.error("[TablePreferences] Failed to delete view:",t),t}}async shareView(e,t){try{const{error:a}=await i.from("table_views").update({is_shared:!0,shared_with:t,updated_at:new Date().toISOString()}).eq("id",e);if(a)throw a}catch(a){throw console.error("[TablePreferences] Failed to share view:",a),a}}async setDefaultView(e,t,a){try{await i.from("table_views").update({is_default:!1}).eq("table_id",e).eq("created_by",a);const{error:r}=await i.from("table_views").update({is_default:!0,updated_at:new Date().toISOString()}).eq("id",t);if(r)throw r}catch(r){throw console.error("[TablePreferences] Failed to set default view:",r),r}}async getDefaultView(e,t){try{const{data:a,error:r}=await i.from("table_views").select("*").eq("table_id",e).eq("created_by",t).eq("is_default",!0).single();if(r){if(r.code==="PGRST116")return null;throw r}return a?this.mapViewFromDb(a):null}catch(a){return console.error("[TablePreferences] Failed to get default view:",a),null}}async deleteTablePreferences(e){try{await i.from("table_preferences").delete().eq("table_id",e),await i.from("table_views").delete().eq("table_id",e)}catch(t){throw console.error("[TablePreferences] Failed to delete table preferences:",t),t}}async exportPreferences(e,t){try{const[a,r]=await Promise.all([this.fetchPreferences(e,t),this.fetchViews(e,t)]);return{preferences:a,views:r}}catch(a){throw console.error("[TablePreferences] Failed to export preferences:",a),a}}async importPreferences(e){try{e.preferences&&await this.savePreferences(e.preferences);for(const t of e.views)await this.saveView(t.tableId,t)}catch(t){throw console.error("[TablePreferences] Failed to import preferences:",t),t}}mapViewFromDb(e){return{id:e.id,name:e.name,description:e.description,tableId:e.table_id,columns:e.columns,columnWidths:e.column_widths,pinnedColumns:e.pinned_columns,createdBy:e.created_by,isShared:e.is_shared,sharedWith:e.shared_with,isDefault:e.is_default,createdAt:e.created_at,updatedAt:e.updated_at}}}const u=n.getInstance();export{n as TablePreferencesService,u as tablePreferencesService};
